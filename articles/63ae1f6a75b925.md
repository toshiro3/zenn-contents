---
title: "AWS Athenaã§ALBã®ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã‚’åˆ†æã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹"
emoji: "ğŸ¤–"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["aws", "Athena", "ALB"]
published: true
---

# ã¯ã˜ã‚ã«

ç‰¹å®šã®ãƒšãƒ¼ã‚¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ•°ã‚’ç¢ºèªã—ã‚ˆã†ã¨æ€ã„ã€Athenaã‚’åˆ©ç”¨ã—ã¦ALBã®ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã‚’æ¤œç´¢ã—ã‚ˆã†ã™ã‚‹ã¨ã€ãƒ†ãƒ¼ãƒ–ãƒ«ã¯å­˜åœ¨ã™ã‚‹ã‚‚ã®ã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®è¨­å®šãŒè¡Œã‚ã‚Œã¦ã„ãªã„ã¨ã„ã†çŠ¶æ³ã«ã§ãã‚ã—ãŸã®ã§ã€ã‚ã‚‰ãŸã‚ã¦Athenaã®ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆæ–¹æ³•ã‚’ã¾ã¨ã‚ã¦ãŠã“ã†ã¨æ€ã„ã¾ã™ã€‚

# Athenaã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã™ã‚‹

ä»¥é™ã¯ã€Athenaã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚ˆã‚Šæ“ä½œã—ã¾ã™ã€‚

### ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³è¨­å®šã—ãªã„å ´åˆ

ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦ã€ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```sql
CREATE EXTERNAL TABLE IF NOT EXISTS alb_logs (
            type string,
            time string,
            elb string,
            client_ip string,
            client_port int,
            target_ip string,
            target_port int,
            request_processing_time double,
            target_processing_time double,
            response_processing_time double,
            elb_status_code int,
            target_status_code string,
            received_bytes bigint,
            sent_bytes bigint,
            request_verb string,
            request_url string,
            request_proto string,
            user_agent string,
            ssl_cipher string,
            ssl_protocol string,
            target_group_arn string,
            trace_id string,
            domain_name string,
            chosen_cert_arn string,
            matched_rule_priority string,
            request_creation_time string,
            actions_executed string,
            redirect_url string,
            lambda_error_reason string,
            target_port_list string,
            target_status_code_list string,
            classification string,
            classification_reason string
            )
            ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.RegexSerDe'
            WITH SERDEPROPERTIES (
            'serialization.format' = '1',
            'input.regex' =
        '([^ ]*) ([^ ]*) ([^ ]*) ([^ ]*):([0-9]*) ([^ ]*)[:-]([0-9]*) ([-.0-9]*) ([-.0-9]*) ([-.0-9]*) (|[-0-9]*) (-|[-0-9]*) ([-0-9]*) ([-0-9]*) \"([^ ]*) (.*) (- |[^ ]*)\" \"([^\"]*)\" ([A-Z0-9-_]+) ([A-Za-z0-9.-]*) ([^ ]*) \"([^\"]*)\" \"([^\"]*)\" \"([^\"]*)\" ([-.0-9]*) ([^ ]*) \"([^\"]*)\" \"([^\"]*)\" \"([^ ]*)\" \"([^\s]+?)\" \"([^\s]+)\" \"([^ ]*)\" \"([^ ]*)\"')
            LOCATION 's3://{BUCKET_NAME}/AWSLogs/{AWS_ACCOUNT_ID}/elasticloadbalancing/{AWS_REGION}/'
```

### ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³è¨­å®šã‚’ã™ã‚‹å ´åˆ

* ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ç®¡ç†ã‚’è‡ªèº«ã§è¡Œã†å ´åˆ

ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦ã€ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```sql
CREATE EXTERNAL TABLE IF NOT EXISTS alb_logs_partitioned (
            type string,
            time string,
            elb string,
            client_ip string,
            client_port int,
            target_ip string,
            target_port int,
            request_processing_time double,
            target_processing_time double,
            response_processing_time double,
            elb_status_code int,
            target_status_code string,
            received_bytes bigint,
            sent_bytes bigint,
            request_verb string,
            request_url string,
            request_proto string,
            user_agent string,
            ssl_cipher string,
            ssl_protocol string,
            target_group_arn string,
            trace_id string,
            domain_name string,
            chosen_cert_arn string,
            matched_rule_priority string,
            request_creation_time string,
            actions_executed string,
            redirect_url string,
            lambda_error_reason string,
            target_port_list string,
            target_status_code_list string,
            classification string,
            classification_reason string
            )
            PARTITIONED BY
            (
                year string,
                month string,
                day string
            )
            ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.RegexSerDe'
            WITH SERDEPROPERTIES (
            'serialization.format' = '1',
            'input.regex' =
        '([^ ]*) ([^ ]*) ([^ ]*) ([^ ]*):([0-9]*) ([^ ]*)[:-]([0-9]*) ([-.0-9]*) ([-.0-9]*) ([-.0-9]*) (|[-0-9]*) (-|[-0-9]*) ([-0-9]*) ([-0-9]*) \"([^ ]*) (.*) (- |[^ ]*)\" \"([^\"]*)\" ([A-Z0-9-_]+) ([A-Za-z0-9.-]*) ([^ ]*) \"([^\"]*)\" \"([^\"]*)\" \"([^\"]*)\" ([-.0-9]*) ([^ ]*) \"([^\"]*)\" \"([^\"]*)\" \"([^ ]*)\" \"([^\s]+?)\" \"([^\s]+)\" \"([^ ]*)\" \"([^ ]*)\"')
            LOCATION 's3://{BUCKET_NAME}/AWSLogs/{AWS_ACCOUNT_ID}/elasticloadbalancing/{AWS_REGION}/'
```

ãã®å¾Œã€ä»»æ„ã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚­ãƒ¼(year, month, day)ã‚’æŒ‡å®šã—ã¦ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```sql
ALTER TABLE alb_logs_partitioned ADD
  PARTITION (year = '2022', month ='07', day= '30')
  LOCATION's3://{BUCKET_NAME}/AWSLogs/{AWS_ACCOUNT_ID}/elasticloadbalancing/{AWS_REGION}/2022/07/30/'
```

* Prtition Projectionã§ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ç®¡ç†ã‚’è‡ªå‹•åŒ–ã™ã‚‹å ´åˆ

ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦ã€ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```sql
CREATE EXTERNAL TABLE IF NOT EXISTS alb_log_partition_projection (
            type string,
            time string,
            elb string,
            client_ip string,
            client_port int,
            target_ip string,
            target_port int,
            request_processing_time double,
            target_processing_time double,
            response_processing_time double,
            elb_status_code int,
            target_status_code string,
            received_bytes bigint,
            sent_bytes bigint,
            request_verb string,
            request_url string,
            request_proto string,
            user_agent string,
            ssl_cipher string,
            ssl_protocol string,
            target_group_arn string,
            trace_id string,
            domain_name string,
            chosen_cert_arn string,
            matched_rule_priority string,
            request_creation_time string,
            actions_executed string,
            redirect_url string,
            lambda_error_reason string,
            target_port_list string,
            target_status_code_list string,
            classification string,
            classification_reason string
            )
            PARTITIONED BY
            (
             date string
            )
            ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.RegexSerDe'
            WITH SERDEPROPERTIES (
            'serialization.format' = '1',
            'input.regex' =
        '([^ ]*) ([^ ]*) ([^ ]*) ([^ ]*):([0-9]*) ([^ ]*)[:-]([0-9]*) ([-.0-9]*) ([-.0-9]*) ([-.0-9]*) (|[-0-9]*) (-|[-0-9]*) ([-0-9]*) ([-0-9]*) \"([^ ]*) (.*) (- |[^ ]*)\" \"([^\"]*)\" ([A-Z0-9-_]+) ([A-Za-z0-9.-]*) ([^ ]*) \"([^\"]*)\" \"([^\"]*)\" \"([^\"]*)\" ([-.0-9]*) ([^ ]*) \"([^\"]*)\" \"([^\"]*)\" \"([^ ]*)\" \"([^\s]+?)\" \"([^\s]+)\" \"([^ ]*)\" \"([^ ]*)\"')
            LOCATION 's3://{BUCKET_NAME}/AWSLogs/{AWS_ACCOUNT_ID}/elasticloadbalancing/{AWS_REGION}/'
            TBLPROPERTIES
            (
             "projection.enabled" = "true",
             "projection.date.type" = "date",
             "projection.date.range" = "2022/01/01,NOW",
             "projection.date.format" = "yyyy/MM/dd",
             "projection.date.interval" = "1",
             "projection.date.interval.unit" = "DAYS",
             "storage.location.template" = "s3://{BUCKET_NAME}/AWSLogs/{AWS_ACCOUNT_ID}/elasticloadbalancing/{AWS_REGION}/${date}"
            )
```

# ã¾ã¨ã‚

Athenaã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚ˆã‚Šã€ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã™ã‚‹æ–¹æ³•ã‚’è¨˜è¿°ã—ã¾ã—ãŸã€‚ã¾ãŸã€ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³è¨­å®šã‚’ã—ãªã„æ–¹æ³•ã¨ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³è¨­å®šã‚’ã™ã‚‹æ–¹æ³•ã‚’è¨˜è¿°ã—ã€ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³è¨­å®šã‚’ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ã¯ã€ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ç®¡ç†ã‚’è‡ªèº«ã§è¡Œã†æ–¹æ³•ã¨ã€Partition Projectionã‚’åˆ©ç”¨ã—ã¦ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ç®¡ç†ã‚’è‡ªå‹•åŒ–ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ã‚‚è¨˜è¿°ã—ã¾ã—ãŸã€‚

# å‚è€ƒ

* [Application Load Balancer ãƒ­ã‚°ã®ã‚¯ã‚¨ãƒª](https://docs.aws.amazon.com/ja_jp/athena/latest/ug/application-load-balancer-logs.html)
* [Amazon Athena ã‚’ä½¿ç”¨ã—ã¦ Application Load Balancer ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã‚’åˆ†æã™ã‚‹ã«ã¯ã©ã†ã™ã‚Œã°ã‚ˆã„ã§ã™ã‹ã€‚](https://aws.amazon.com/jp/premiumsupport/knowledge-center/athena-analyze-access-logs/)