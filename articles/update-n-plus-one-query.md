---
title: "æ›´æ–°ç³»ã®N+1ã‚¯ã‚¨ãƒªã€æœ¬å½“ã«è§£æ¶ˆã™ã¹ãï¼ŸCASEæ–‡ãƒ»ä¸€æ™‚ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã‚ˆã‚‹è§£æ±ºç­–ã¨åˆ¤æ–­åŸºæº–"
emoji: "ğŸ”„"
type: "tech"
topics: ["Laravel", "MySQL", "PHP", "ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹"]
published: false
---

## ã¯ã˜ã‚ã«

N+1ã‚¯ã‚¨ãƒªã¨ã„ãˆã°ã€å¤šãã®å ´åˆã€ŒSELECTæ–‡ã€ã®å•é¡Œã¨ã—ã¦èªã‚‰ã‚Œã¾ã™ã€‚Eloquentã® `with()` ã‚’ä½¿ã£ãŸ Eager Loading ã§è§£æ±ºã€ã¨ã„ã†ã®ã¯ Laravel ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã«ã¯ãŠé¦´æŸ“ã¿ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã™ã­ã€‚

ã—ã‹ã—ã€**UPDATEæ–‡ã®N+1å•é¡Œ**ã«ã¤ã„ã¦ã¯ã©ã†ã§ã—ã‚‡ã†ã‹ï¼Ÿãƒ«ãƒ¼ãƒ—å†…ã§1ä»¶ãšã¤UPDATEã‚’ç™ºè¡Œã™ã‚‹ã‚³ãƒ¼ãƒ‰ã¯ã€ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§æŒ‡æ‘˜ã•ã‚Œã‚‹ã“ã¨ã‚‚ã‚ã‚Šã¾ã™ãŒã€å®Ÿéš›ã«ã©ã†å¯¾å‡¦ã™ã¹ãã‹æ‚©ã‚€ã‚±ãƒ¼ã‚¹ã‚‚å¤šã„ã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚

æœ¬è¨˜äº‹ã§ã¯ã€æ›´æ–°ç³»N+1ã‚¯ã‚¨ãƒªã®è§£æ¶ˆæ–¹æ³•ã¨ã—ã¦ã€ŒCASEæ–‡ã«ã‚ˆã‚‹ãƒãƒ«ã‚¯UPDATEã€ã¨ã€Œä¸€æ™‚ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½¿ã£ãŸJOIN UPDATEã€ã‚’ç´¹ä»‹ã—ã¤ã¤ã€**ãã‚‚ãã‚‚å¯¾å¿œã™ã¹ãã‹ã©ã†ã‹ã®åˆ¤æ–­åŸºæº–**ã«ã¤ã„ã¦ã‚‚è€ƒãˆã¦ã¿ã¾ã™ã€‚

## å•é¡Œã®èƒŒæ™¯

### å…¸å‹çš„ãªN+1 UPDATE

ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ãŒã‚ã£ãŸã¨ã—ã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ³¨æ–‡æƒ…å ±ã‚’ä¸€æ‹¬ã§æ›´æ–°ã™ã‚‹å‡¦ç†ã§ã™ã€‚

```php
public function updateOrderStatus(Request $request): void
{
    $orders = $request->input('orders');
    $now = now();

    foreach ($orders as $order) {
        DB::table('orders')
            ->where('id', $order['order_id'])
            ->update([
                'status' => $order['status'],
                'updated_at' => $now,
            ]);

        SendNotificationJob::dispatch($order['order_id'], $order['status']);
    }
}
```

ã“ã®ã‚³ãƒ¼ãƒ‰ã¯ã€`$orders` ã®ä»¶æ•°åˆ†ã ã‘ UPDATE æ–‡ãŒç™ºè¡Œã•ã‚Œã¾ã™ã€‚10ä»¶ãªã‚‰10å›ã€100ä»¶ãªã‚‰100å›ã§ã™ã€‚

### ä½•ãŒå•é¡Œãªã®ã‹

| è¦³ç‚¹ | å½±éŸ¿ |
|------|------|
| ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ©ã‚¦ãƒ³ãƒ‰ãƒˆãƒªãƒƒãƒ— | DBã‚µãƒ¼ãƒãƒ¼ã¸ã®å¾€å¾©ãŒä»¶æ•°åˆ†ç™ºç”Ÿ |
| ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãƒ­ã‚° | å„UPDATEã”ã¨ã«ãƒ­ã‚°æ›¸ãè¾¼ã¿ |
| ãƒ­ãƒƒã‚¯ç«¶åˆ | æ›´æ–°å¯¾è±¡ã®è¡ŒãŒåˆ†æ•£ã—ã¦ã„ã‚‹ã¨å½±éŸ¿ã¯é™å®šçš„ã ãŒã€åŒä¸€è¡Œã¸ã®æ›´æ–°ãŒå¤šã„ã¨å•é¡Œã« |
| ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³å æœ‰æ™‚é–“ | å‡¦ç†æ™‚é–“ã«æ¯”ä¾‹ã—ã¦é•·ããªã‚‹ |

ãŸã ã—ã€**ä»¶æ•°ãŒå°‘ãªã‘ã‚Œã°å®Ÿå®³ã¯ã»ã¼ã‚ã‚Šã¾ã›ã‚“**ã€‚ã“ã‚ŒãŒåˆ¤æ–­ã‚’é›£ã—ãã™ã‚‹ãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚

## è§£æ±ºç­–1: CASEæ–‡ã«ã‚ˆã‚‹ãƒãƒ«ã‚¯UPDATE

è¤‡æ•°è¡Œã‚’1ã¤ã®UPDATEæ–‡ã§æ›´æ–°ã™ã‚‹æ–¹æ³•ã§ã™ã€‚

### åŸºæœ¬çš„ãªè€ƒãˆæ–¹

```sql
UPDATE orders
SET 
    status = CASE id
        WHEN 1 THEN 'shipped'
        WHEN 2 THEN 'delivered'
        WHEN 3 THEN 'cancelled'
    END,
    updated_at = '2025-12-22 12:00:00'
WHERE id IN (1, 2, 3);
```

å„IDã«å¯¾å¿œã™ã‚‹å€¤ã‚’CASEæ–‡ã§æŒ¯ã‚Šåˆ†ã‘ã‚‹ã“ã¨ã§ã€1å›ã®ã‚¯ã‚¨ãƒªã§è¤‡æ•°è¡Œã‚’æ›´æ–°ã§ãã¾ã™ã€‚

### Laravelã§ã®å®Ÿè£…

```php
public function updateOrderStatus(Request $request): void
{
    $orders = $request->input('orders');

    if (empty($orders)) {
        return;
    }

    $this->bulkUpdateStatus($orders);

    // Jobã®dispatchã¯å€‹åˆ¥ã«è¡Œã†ï¼ˆãƒãƒƒãƒåŒ–ã¯åˆ¥é€”æ¤œè¨ï¼‰
    foreach ($orders as $order) {
        SendNotificationJob::dispatch($order['order_id'], $order['status']);
    }
}

private function bulkUpdateStatus(array $orders): void
{
    $ids = [];
    $cases = [];
    $bindings = [];

    foreach ($orders as $order) {
        $ids[] = $order['order_id'];
        $cases[] = "WHEN ? THEN ?";
        $bindings[] = $order['order_id'];
        $bindings[] = $order['status'];
    }

    $caseStatement = implode(' ', $cases);
    $idPlaceholders = implode(',', array_fill(0, count($ids), '?'));

    $sql = "
        UPDATE orders
        SET 
            status = CASE id {$caseStatement} END,
            updated_at = ?
        WHERE id IN ({$idPlaceholders})
    ";

    // ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã®é †åº: CASEæ–‡ã®ãƒšã‚¢ â†’ updated_at â†’ INå¥ã®ID
    $bindings[] = now();
    $bindings = array_merge($bindings, $ids);

    DB::update($sql, $bindings);
}
```

### æ±ç”¨çš„ãªãƒ˜ãƒ«ãƒ‘ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰

å†åˆ©ç”¨ã—ã‚„ã™ã„å½¢ã«ã¾ã¨ã‚ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```php
/**
 * CASEæ–‡ã‚’ä½¿ã£ãŸè¤‡æ•°è¡Œã®ä¸€æ‹¬æ›´æ–°
 *
 * @param string $table ãƒ†ãƒ¼ãƒ–ãƒ«å
 * @param string $keyColumn ä¸»ã‚­ãƒ¼ã¾ãŸã¯ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚­ãƒ¼ã®ã‚«ãƒ©ãƒ å
 * @param array $updates ['key_value' => ['column1' => 'value1', 'column2' => 'value2'], ...]
 */
function bulkUpdate(string $table, string $keyColumn, array $updates): int
{
    if (empty($updates)) {
        return 0;
    }

    $keys = array_keys($updates);
    $columns = array_keys(reset($updates));

    $cases = [];
    $bindings = [];

    foreach ($columns as $column) {
        $whenClauses = [];
        foreach ($updates as $key => $values) {
            $whenClauses[] = "WHEN ? THEN ?";
            $bindings[] = $key;
            $bindings[] = $values[$column];
        }
        $cases[] = "{$column} = CASE {$keyColumn} " . implode(' ', $whenClauses) . " END";
    }

    $keyPlaceholders = implode(',', array_fill(0, count($keys), '?'));
    $bindings = array_merge($bindings, $keys);

    $sql = "UPDATE {$table} SET " . implode(', ', $cases) . " WHERE {$keyColumn} IN ({$keyPlaceholders})";

    return DB::update($sql, $bindings);
}

// ä½¿ç”¨ä¾‹
bulkUpdate('orders', 'id', [
    1 => ['status' => 'shipped', 'updated_at' => now()],
    2 => ['status' => 'delivered', 'updated_at' => now()],
    3 => ['status' => 'cancelled', 'updated_at' => now()],
]);
```

### CASEæ–‡æ–¹å¼ã®ãƒ¡ãƒªãƒƒãƒˆãƒ»ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ

| ãƒ¡ãƒªãƒƒãƒˆ | ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ |
|----------|------------|
| 1å›ã®ã‚¯ã‚¨ãƒªã§å®Œçµ | SQLãŒè¤‡é›‘ã«ãªã‚‹ |
| è¿½åŠ ã®ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆä¸è¦ | ä»¶æ•°ãŒå¤šã„ã¨SQLãŒè‚¥å¤§åŒ– |
| ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†ãŒã‚·ãƒ³ãƒ—ãƒ« | ãƒ‡ãƒãƒƒã‚°ãŒé›£ã—ã„ |

## è§£æ±ºç­–2: ä¸€æ™‚ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½¿ã£ãŸJOIN UPDATE

æ›´æ–°ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ™‚ãƒ†ãƒ¼ãƒ–ãƒ«ã«æ ¼ç´ã—ã€JOINã§ä¸€æ‹¬æ›´æ–°ã™ã‚‹æ–¹æ³•ã§ã™ã€‚

### åŸºæœ¬çš„ãªè€ƒãˆæ–¹

```sql
-- 1. ä¸€æ™‚ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ
CREATE TEMPORARY TABLE tmp_order_updates (
    id BIGINT PRIMARY KEY,
    status VARCHAR(50)
);

-- 2. æ›´æ–°ãƒ‡ãƒ¼ã‚¿ã‚’æŒ¿å…¥
INSERT INTO tmp_order_updates (id, status) VALUES
    (1, 'shipped'),
    (2, 'delivered'),
    (3, 'cancelled');

-- 3. JOINã§ä¸€æ‹¬æ›´æ–°
UPDATE orders o
INNER JOIN tmp_order_updates t ON o.id = t.id
SET 
    o.status = t.status,
    o.updated_at = '2025-12-22 12:00:00';

-- 4. ä¸€æ™‚ãƒ†ãƒ¼ãƒ–ãƒ«ã¯æ¥ç¶šçµ‚äº†æ™‚ã«è‡ªå‹•å‰Šé™¤ï¼ˆæ˜ç¤ºçš„ã«å‰Šé™¤ã‚‚å¯ï¼‰
DROP TEMPORARY TABLE IF EXISTS tmp_order_updates;
```

### Laravelã§ã®å®Ÿè£…

```php
public function updateOrderStatus(Request $request): void
{
    $orders = $request->input('orders');

    if (empty($orders)) {
        return;
    }

    $this->bulkUpdateWithTempTable($orders);

    foreach ($orders as $order) {
        SendNotificationJob::dispatch($order['order_id'], $order['status']);
    }
}

private function bulkUpdateWithTempTable(array $orders): void
{
    // 1. ä¸€æ™‚ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
    DB::statement("
        CREATE TEMPORARY TABLE tmp_order_updates (
            id BIGINT PRIMARY KEY,
            status VARCHAR(50)
        )
    ");

    // 2. ãƒ‡ãƒ¼ã‚¿æŒ¿å…¥ï¼ˆãƒãƒ«ã‚¯ã‚¤ãƒ³ã‚µãƒ¼ãƒˆï¼‰
    $insertData = array_map(fn($order) => [
        'id' => $order['order_id'],
        'status' => $order['status'],
    ], $orders);

    DB::table('tmp_order_updates')->insert($insertData);

    // 3. JOIN UPDATE
    DB::statement("
        UPDATE orders o
        INNER JOIN tmp_order_updates t ON o.id = t.id
        SET 
            o.status = t.status,
            o.updated_at = ?
    ", [now()]);

    // 4. ä¸€æ™‚ãƒ†ãƒ¼ãƒ–ãƒ«å‰Šé™¤ï¼ˆæ˜ç¤ºçš„ã«ï¼‰
    DB::statement("DROP TEMPORARY TABLE IF EXISTS tmp_order_updates");
}
```

### ä¸€æ™‚ãƒ†ãƒ¼ãƒ–ãƒ«æ–¹å¼ã®ãƒ¡ãƒªãƒƒãƒˆãƒ»ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ

| ãƒ¡ãƒªãƒƒãƒˆ | ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ |
|----------|------------|
| å¤§é‡ãƒ‡ãƒ¼ã‚¿ã§ã‚‚SQLãŒã‚·ãƒ³ãƒ—ãƒ« | è¤‡æ•°ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆãŒå¿…è¦ |
| ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ´»ç”¨ã§ãã‚‹ | ä¸€æ™‚ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ |
| ãƒ‡ãƒãƒƒã‚°ã—ã‚„ã™ã„ï¼ˆä¸­é–“ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªå¯èƒ½ï¼‰ | ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†ã«æ³¨æ„ãŒå¿…è¦ |

### ä¸€æ™‚ãƒ†ãƒ¼ãƒ–ãƒ«åˆ©ç”¨æ™‚ã®æ³¨æ„ç‚¹

MySQLã®ä¸€æ™‚ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆ`TEMPORARY TABLE`ï¼‰ã¯**ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ï¼‰ã‚¹ã‚³ãƒ¼ãƒ—**ã§ã™ã€‚ç•°ãªã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒåˆ¥ã®DBã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¦ã„ã‚Œã°ã€åŒåã®ä¸€æ™‚ãƒ†ãƒ¼ãƒ–ãƒ«ã§ã‚‚è¡çªã—ã¾ã›ã‚“ã€‚ï¼ˆè©³ç´°ã¯[ãŠã¾ã‘: ä¸€æ™‚ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¹ã‚³ãƒ¼ãƒ—ã‚’æ¤œè¨¼ã™ã‚‹](#ãŠã¾ã‘%3A-ä¸€æ™‚ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¹ã‚³ãƒ¼ãƒ—ã‚’æ¤œè¨¼ã™ã‚‹)ã‚’å‚ç…§ï¼‰

ãŸã ã—ã€ä»¥ä¸‹ã®ã‚±ãƒ¼ã‚¹ã§ã¯å•é¡Œã«ãªã‚Šã¾ã™ã€‚

- **åŒä¸€ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…ã§åŒã˜å‡¦ç†ã‚’2å›å‘¼ã³å‡ºã—ãŸå ´åˆ**
- **Laravel Octaneç­‰ã®æ°¸ç¶šçš„ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³åˆ©ç”¨æ™‚**ï¼ˆå‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ä¸€æ™‚ãƒ†ãƒ¼ãƒ–ãƒ«ãŒæ®‹ã‚‹å¯èƒ½æ€§ï¼‰

**å¯¾ç­–: ä½œæˆå‰ã«å‰Šé™¤ã™ã‚‹**

```php
private function bulkUpdateWithTempTable(array $orders): void
{
    // æ—¢å­˜ã®ä¸€æ™‚ãƒ†ãƒ¼ãƒ–ãƒ«ãŒã‚ã‚Œã°å‰Šé™¤
    DB::statement("DROP TEMPORARY TABLE IF EXISTS tmp_order_updates");

    // ä¸€æ™‚ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
    DB::statement("
        CREATE TEMPORARY TABLE tmp_order_updates (
            id BIGINT PRIMARY KEY,
            status VARCHAR(50)
        )
    ");

    // ... ä»¥ä¸‹åŒã˜
}
```

## ä¸¡æ–¹å¼ã®æ¯”è¼ƒ

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç‰¹æ€§

| ä»¶æ•° | CASEæ–‡ | ä¸€æ™‚ãƒ†ãƒ¼ãƒ–ãƒ« |
|------|--------|--------------|
| ã€œ10ä»¶ | â— é«˜é€Ÿ | â–³ ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãŒç›®ç«‹ã¤ |
| 10ã€œ100ä»¶ | â—‹ è‰¯å¥½ | â—‹ è‰¯å¥½ |
| 100ã€œ1000ä»¶ | â–³ SQLãŒè‚¥å¤§åŒ– | â— å®‰å®š |
| 1000ä»¶ã€œ | Ã— å®Ÿç”¨çš„ã§ãªã„ | â—‹ ä¾ç„¶ã¨ã—ã¦æœ‰åŠ¹ |

### é¸æŠã®ç›®å®‰

- **ä»¶æ•°ãŒå°‘ãªã„ï¼ˆã€œæ•°åä»¶ï¼‰**: CASEæ–‡ãŒã‚·ãƒ³ãƒ—ãƒ«
- **ä»¶æ•°ãŒå¤šã„ãƒ»å¯å¤‰**: ä¸€æ™‚ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå®‰å®š
- **æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¸ã®å½±éŸ¿ã‚’æœ€å°åŒ–ã—ãŸã„**: CASEæ–‡ï¼ˆè¿½åŠ ã‚¯ã‚¨ãƒªãªã—ï¼‰
- **ãƒ‡ãƒãƒƒã‚°ã®ã—ã‚„ã™ã•é‡è¦–**: ä¸€æ™‚ãƒ†ãƒ¼ãƒ–ãƒ«

## ã€Œå¯¾å¿œã—ãªã„ã€ã¨ã„ã†é¸æŠè‚¢

ã“ã“ã¾ã§è§£æ±ºç­–ã‚’ç´¹ä»‹ã—ã¦ãã¾ã—ãŸãŒã€**å®Ÿéš›ã«ã¯å¯¾å¿œã—ãªã„ã¨ã„ã†åˆ¤æ–­ã‚‚ååˆ†ã«ã‚ã‚Šå¾—ã¾ã™**ã€‚

### å¯¾å¿œã‚’è¦‹é€ã‚‹æ¡ä»¶

ä»¥ä¸‹ã®ã‚ˆã†ãªå ´åˆã€N+1ã®ã¾ã¾ç¶­æŒã™ã‚‹ã®ã‚‚åˆç†çš„ãªé¸æŠã§ã™ã€‚

1. **ä»¶æ•°ãŒå¸¸ã«å°‘ãªã„ï¼ˆæ•°ä»¶ã€œåæ•°ä»¶ï¼‰**
   - 10å›ã®UPDATEã§ã‚‚ã€å®Ÿè¡Œæ™‚é–“ã¯æ•°åãƒŸãƒªç§’ç¨‹åº¦
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“æ„Ÿã«å½±éŸ¿ã—ãªã„ãƒ¬ãƒ™ãƒ«

2. **é »åº¦ãŒä½ã„**
   - 1æ—¥ã«æ•°å›ç¨‹åº¦ã—ã‹å®Ÿè¡Œã•ã‚Œãªã„å‡¦ç†
   - ãƒãƒƒãƒå‡¦ç†ã§ãƒ”ãƒ¼ã‚¯æ™‚é–“å¸¯ã‚’é¿ã‘ã‚‰ã‚Œã‚‹

3. **ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§ãƒ»ä¿å®ˆæ€§ã‚’å„ªå…ˆã—ãŸã„**
   - CASEæ–‡ã‚„SQLæ§‹ç¯‰ãƒ­ã‚¸ãƒƒã‚¯ã¯è¤‡é›‘ã«ãªã‚ŠãŒã¡
   - æ¬¡ã«è§¦ã‚‹äººãŒç†è§£ã—ã‚„ã™ã„ã‚³ãƒ¼ãƒ‰ã®ä¾¡å€¤

4. **å°†æ¥çš„ã«ä»¶æ•°ãŒå¢—ãˆã‚‹è¦‹è¾¼ã¿ãŒãªã„**
   - ãƒ“ã‚¸ãƒã‚¹è¦ä»¶ä¸Šã€ä¸Šé™ãŒæ±ºã¾ã£ã¦ã„ã‚‹

### å®Ÿéš›ã®åˆ¤æ–­ä¾‹

å†’é ­ã§ç´¹ä»‹ã—ãŸã‚³ãƒ¼ãƒ‰ã«ã¤ã„ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ®‹ã—ã¦å¯¾å¿œã‚’è¦‹é€ã‚Šã¾ã—ãŸã€‚

```php
/**
 * æ³¨æ–‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ä¸€æ‹¬æ›´æ–°
 *
 * NOTE: ãƒ«ãƒ¼ãƒ—å†…ã§UPDATEæ–‡ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã€N+1ã‚¯ã‚¨ãƒªãŒç™ºç”Ÿã—ã¾ã™ã€‚
 * ç¾çŠ¶ã¯æ•°ä»¶ç¨‹åº¦ã®å‡¦ç†ã‚’æƒ³å®šã—ã¦ãŠã‚Šã€å®Ÿè£…ã®ã‚·ãƒ³ãƒ—ãƒ«ã•ã‚’å„ªå…ˆã—ã¦ã„ã¾ã™ã€‚
 * ä»¶æ•°ãŒå¢—åŠ ã™ã‚‹å ´åˆã¯ã€CASEæ–‡ã«ã‚ˆã‚‹ãƒãƒ«ã‚¯æ›´æ–°ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚
 */
public function updateOrderStatus(Request $request): void
{
    // ...
}
```

ã“ã†ã—ã¦ãŠã‘ã°ã€å°†æ¥çš„ã«ä»¶æ•°ãŒå¢—ãˆãŸéš›ã«å¯¾å¿œæ–¹é‡ãŒæ˜ç¢ºã«ãªã‚Šã¾ã™ã€‚

### åˆ¤æ–­ã®ãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ

```
æ›´æ–°ä»¶æ•°ã¯å¸¸ã«å°‘ãªã„ï¼ˆã€œ10ä»¶ï¼‰ï¼Ÿ
    â”œâ”€ Yes â†’ å¯¾å¿œä¸è¦ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆã§æ„å›³ã‚’æ®‹ã™ï¼‰
    â””â”€ No
        â†“
ä»¶æ•°ã¯äºˆæ¸¬å¯èƒ½ï¼Ÿ
    â”œâ”€ Yesï¼ˆã€œ100ä»¶ç¨‹åº¦ï¼‰â†’ CASEæ–‡
    â””â”€ No / å¤§é‡ã«ãªã‚‹å¯èƒ½æ€§ â†’ ä¸€æ™‚ãƒ†ãƒ¼ãƒ–ãƒ«
```

## upsert()ã§ã‚‚åŒæ§˜ã®ã“ã¨ã¯ã§ãã‚‹ï¼Ÿ

Laravel ã® `upsert()` ã‚’ä½¿ãˆã°ä¼¼ãŸã‚ˆã†ãªã“ã¨ãŒã§ãã‚‹ã®ã§ã¯ï¼Ÿã¨æ€ã‚ã‚Œã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

```php
Order::upsert(
    [
        ['id' => 1, 'status' => 'shipped', 'updated_at' => now()],
        ['id' => 2, 'status' => 'delivered', 'updated_at' => now()],
    ],
    ['id'],           // ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚­ãƒ¼
    ['status', 'updated_at']  // æ›´æ–°å¯¾è±¡ã‚«ãƒ©ãƒ 
);
```

ã“ã‚Œã¯å†…éƒ¨çš„ã« `INSERT ... ON DUPLICATE KEY UPDATE` ã‚’ç™ºè¡Œã—ã¾ã™ã€‚

### upsert()ã¨ã®é•ã„

| è¦³ç‚¹ | CASEæ–‡/ä¸€æ™‚ãƒ†ãƒ¼ãƒ–ãƒ« | upsert() |
|------|---------------------|----------|
| ç”¨é€” | ç´”ç²‹ãªUPDATE | INSERT or UPDATE |
| å­˜åœ¨ã—ãªã„ã‚­ãƒ¼ | ã‚¨ãƒ©ãƒ¼ã«ãªã‚‰ãªã„ï¼ˆæ›´æ–°0ä»¶ï¼‰ | INSERTã•ã‚Œã‚‹ |
| å…¨ã‚«ãƒ©ãƒ æŒ‡å®š | æ›´æ–°ã‚«ãƒ©ãƒ ã®ã¿ã§OK | INSERTç”¨ã«å…¨ã‚«ãƒ©ãƒ å¿…è¦ãªå ´åˆã‚‚ |

**æ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰ã®æ›´æ–°ã®ã¿**ã‚’æ„å›³ã—ã¦ã„ã‚‹å ´åˆã¯ã€CASEæ–‡ã‚„ä¸€æ™‚ãƒ†ãƒ¼ãƒ–ãƒ«æ–¹å¼ã®æ–¹ãŒæ„å›³ãŒæ˜ç¢ºã§ã™ã€‚

## ã¾ã¨ã‚

æ›´æ–°ç³»ã®N+1ã‚¯ã‚¨ãƒªã«ã¯ã€ä»¥ä¸‹ã®è§£æ±ºç­–ãŒã‚ã‚Šã¾ã™ã€‚

| æ–¹å¼ | é©ã—ãŸã‚±ãƒ¼ã‚¹ |
|------|-------------|
| CASEæ–‡ | ä»¶æ•°ãŒå°‘ã€œä¸­ç¨‹åº¦ã€è¿½åŠ ã‚¯ã‚¨ãƒªã‚’é¿ã‘ãŸã„ |
| ä¸€æ™‚ãƒ†ãƒ¼ãƒ–ãƒ« | ä»¶æ•°ãŒå¤šã„ã€å¯å¤‰ã€ãƒ‡ãƒãƒƒã‚°ã—ã‚„ã™ã•é‡è¦– |
| å¯¾å¿œã—ãªã„ | ä»¶æ•°ãŒå¸¸ã«å°‘ãªã„ã€ã‚·ãƒ³ãƒ—ãƒ«ã•å„ªå…ˆ |

N+1ã‚¯ã‚¨ãƒªã¯ã€Œæ‚ªã€ã¨ã—ã¦èªã‚‰ã‚ŒãŒã¡ã§ã™ãŒã€**ä»¶æ•°ã¨é »åº¦ã«ã‚ˆã£ã¦ã¯éå‰°ãªæœ€é©åŒ–ã«ãªã‚‹ã“ã¨ã‚‚ã‚ã‚Šã¾ã™**ã€‚ã‚³ãƒ¼ãƒ‰ã®è¤‡é›‘ã•ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ã‚’æ„è­˜ã—ã¦ã€é©åˆ‡ãªåˆ¤æ–­ã‚’ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

## ãŠã¾ã‘: ä¸€æ™‚ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¹ã‚³ãƒ¼ãƒ—ã‚’æ¤œè¨¼ã™ã‚‹

MySQLã®ä¸€æ™‚ãƒ†ãƒ¼ãƒ–ãƒ«ãŒã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ã‚³ãƒ¼ãƒ—ã§ã‚ã‚‹ã“ã¨ã‚’ã€CLIã§æ¤œè¨¼ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

### æ¤œè¨¼1: ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†ã§è‡ªå‹•å‰Šé™¤ã•ã‚Œã‚‹

```sql
mysql> CREATE TEMPORARY TABLE tmp_test (id INT);
Query OK, 0 rows affected (0.02 sec)

mysql> INSERT INTO tmp_test VALUES (1), (2), (3);
Query OK, 3 rows affected (0.01 sec)

mysql> SELECT * FROM tmp_test;
+------+
| id   |
+------+
|    1 |
|    2 |
|    3 |
+------+
3 rows in set (0.00 sec)

mysql> exit
Bye
```

å†æ¥ç¶šå¾Œï¼š

```sql
mysql> SELECT * FROM tmp_test;
ERROR 1146 (42S02): Table 'mydb.tmp_test' doesn't exist
```

ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåˆ‡ã‚Œã‚‹ã¨ä¸€æ™‚ãƒ†ãƒ¼ãƒ–ãƒ«ã¯è‡ªå‹•çš„ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚

### æ¤œè¨¼2: åˆ¥ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ã¯åŒåã®ä¸€æ™‚ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå…±å­˜ã§ãã‚‹

ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’2ã¤é–‹ã„ã¦ã€ãã‚Œãã‚Œåˆ¥ã®MySQLã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ç¢ºèªã—ã¾ã™ã€‚

```bash
# ã‚¿ãƒ¼ãƒŸãƒŠãƒ«1
mysql -u root -p your_database

# ã‚¿ãƒ¼ãƒŸãƒŠãƒ«2ï¼ˆåˆ¥ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§ï¼‰
mysql -u root -p your_database
```

```sql
-- ã‚¿ãƒ¼ãƒŸãƒŠãƒ«1
mysql> SELECT CONNECTION_ID();
+-----------------+
| CONNECTION_ID() |
+-----------------+
|              42 |
+-----------------+

mysql> CREATE TEMPORARY TABLE tmp_test (id INT);
mysql> INSERT INTO tmp_test VALUES (1), (2), (3);
```

```sql
-- ã‚¿ãƒ¼ãƒŸãƒŠãƒ«2ï¼ˆã‚¿ãƒ¼ãƒŸãƒŠãƒ«1ã¯é–‹ã„ãŸã¾ã¾ï¼‰
mysql> SELECT CONNECTION_ID();
+-----------------+
| CONNECTION_ID() |
+-----------------+
|              43 |  -- åˆ¥ã®æ¥ç¶šID
+-----------------+

mysql> CREATE TEMPORARY TABLE tmp_test (id INT);  -- ã‚¨ãƒ©ãƒ¼ã«ãªã‚‰ãªã„ï¼
mysql> INSERT INTO tmp_test VALUES (100), (200);
```

```sql
-- ã‚¿ãƒ¼ãƒŸãƒŠãƒ«1ã«æˆ»ã£ã¦ç¢ºèª
mysql> SELECT * FROM tmp_test;
+------+
| id   |
+------+
|    1 |
|    2 |
|    3 |
+------+
-- ã‚¿ãƒ¼ãƒŸãƒŠãƒ«2ã®ãƒ‡ãƒ¼ã‚¿(100, 200)ã¯è¦‹ãˆãªã„
```

```sql
-- ã‚¿ãƒ¼ãƒŸãƒŠãƒ«2ã§ç¢ºèª
mysql> SELECT * FROM tmp_test;
+------+
| id   |
+------+
|  100 |
|  200 |
+------+
-- ã‚¿ãƒ¼ãƒŸãƒŠãƒ«1ã®ãƒ‡ãƒ¼ã‚¿(1, 2, 3)ã¯è¦‹ãˆãªã„
```

ã“ã®ã‚ˆã†ã«ã€**ç•°ãªã‚‹ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ï¼‰ã§ã¯åŒåã®ä¸€æ™‚ãƒ†ãƒ¼ãƒ–ãƒ«ãŒç‹¬ç«‹ã—ã¦å­˜åœ¨**ã—ã¾ã™ã€‚Laravelã®é€šå¸¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†ã§ã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã”ã¨ã«åˆ¥ã®ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãŒä½¿ã‚ã‚Œã‚‹ãŸã‚ã€ä¸¦åˆ—å®Ÿè¡Œã—ã¦ã‚‚è¡çªã—ã¾ã›ã‚“ã€‚

### æ¤œè¨¼3: åŒä¸€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§2å›ä½œæˆã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼

```sql
mysql> CREATE TEMPORARY TABLE tmp_test2 (id INT);
Query OK, 0 rows affected (0.00 sec)

mysql> CREATE TEMPORARY TABLE tmp_test2 (id INT);
ERROR 1050 (42S01): Table 'tmp_test2' already exists
```

åŒä¸€ã‚»ãƒƒã‚·ãƒ§ãƒ³å†…ã§ã¯ã€åŒåã®ä¸€æ™‚ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã§ãã¾ã›ã‚“ã€‚ã“ã‚ŒãŒã€ŒåŒä¸€ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…ã§2å›å‘¼ã³å‡ºã™ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã€ç†ç”±ã§ã™ã€‚

## å‚è€ƒ

- [MySQL - UPDATE Statement](https://dev.mysql.com/doc/refman/8.0/en/update.html)
- [MySQL - CREATE TEMPORARY TABLE](https://dev.mysql.com/doc/refman/8.0/en/create-temporary-table.html)
- [Laravel - Database: Query Builder](https://laravel.com/docs/queries)
